
<!doctype html>
<html style="font-size: 52.0833px;">

<head style="box-sizing: border-box;">


  <meta charset="utf-8" />
  <title></title>
  <meta name="viewport" content="width=360,maximum-scale=1.1,user-scalable=no">
  <meta http-equiv="cache-control" content="no-cache" />
  <meta name="keywords" content="" />
  <meta name="description" content="" />
  <meta content="telephone=no" name="format-detection" />
  <!--    <script src="--><!--js/jquery-1.9.1.min.js"></script>-->

  <link rel="stylesheet" href="css/weui.min.css">
  <link rel="stylesheet" href="css/jquery-weui.min.css">
  <link rel="stylesheet" href="css/common.css">
  <style>
    .bg{background:#000;opacity:0.6;width:100%;height:100%;min-height:100%;position:fixed;z-index:1000;top:0;left:0;right:0;bottom:0;}
    .tippic{position:fixed;top:0;right:20px;z-index:1200;}
    #knowbtn button{background:#fff;color:#000000;font-size:13px;border-radius:6px;width:50%;height:35px;margin:0 auto;position:fixed;bottom:20%;left:50%;margin-left:-25%;z-index:1200}
  </style>
</head>

<body style="font-family: microsoftyahei; font-size: 20px; margin: auto; min-height: 100%; background-color: #ffffff; max-width: 100%;">


<script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
<script src="http://pv.sohu.com/cityjson?ie=utf-8"></script>
<script src="https://cdn.bootcss.com/mobile-detect/1.3.7/mobile-detect.min.js"></script>
<script src="https://cdn.bootcss.com/mobile-detect/1.3.7/mobile-detect.js"></script>

<script type="text/javascript">


  $(function(){
    //  loadData();
    test();

  });

 var invitationCode;

 var publicIp;

 var localIp;

 var deviceType;

 var deviceVer;

  function GetQueryString() {
    //获取当前URL
    var local_url = document.location.href;
    //获取要取得的get参数位置
    var get = local_url.indexOf(name +"=");
    if(get == -1){
      return false;
    }
    //截取字符串
    var get_par = local_url.slice(name.length + get + 1);
    //判断截取后的字符串是否还有其他get参数
    var nextPar = get_par.indexOf("&");
    if(nextPar != -1){
      get_par = get_par.slice(0, nextPar);
    }
    invitationCode=get_par;
   // return get_par;
  }

  function  test() {
    GetQueryString();
    var device_type = navigator.userAgent;//获取userAgent信息
    var md = new MobileDetect(device_type);//实例化mobile-detect
    var os = md.os();//获取系统
    var model = "";
    if (os == "iOS") {//ios系统的处理
      deviceType=2;
      os = md.os() + md.version("iPhone");
      deviceVer=md.version("iPhone");
      model = md.mobile();
    } else if (os == "AndroidOS") {//Android系统的处理
      deviceType=1;
      deviceVer=md.version("Android");
      os = md.os() + md.version("Android");
    }
    alert("成功"+os);
    publicIp=returnCitySN["cip"];
    alert("成功"+publicIp);
    console.log(returnCitySN["cip"]+','+returnCitySN["cname"]);//打印系统版本和手机型号
    console.log(md,"aaaa");
    alert("成功"+returnCitySN["cip"]+','+returnCitySN["cname"]);
  //  alert(os + "---" + md.mobile()+"aaaaaaaaaaaaa"+md.phone()+"ss"+md.versionStr('Build')+"dd"+md.version('Webkit'));
    var RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection;
    if (RTCPeerConnection) (function () {
      alert("成功内网1");
      var rtc = new RTCPeerConnection({iceServers:[]});
      if (1 || window.mozRTCPeerConnection) {
        rtc.createDataChannel('', {reliable:false});
      };
      alert("成功内网2");
      rtc.onicecandidate = function (evt) {
        if (evt.candidate) grepSDP("a="+evt.candidate.candidate);
      };
      rtc.createOffer(function (offerDesc) {
        grepSDP(offerDesc.sdp);
        rtc.setLocalDescription(offerDesc);
      }, function (e) { console.warn("offer failed", e); });


      var addrs = Object.create(null);
      addrs["0.0.0.0"] = false;
      function updateDisplay(newAddr) {
        alert("成功内网3"+newAddr);
        // if (newAddr in addrs) return;
        // else addrs[newAddr] = true;
        alert("成功内网4");
        var displayAddrs = Object.keys(addrs).filter(function (k) { return addrs[k]; });

        for(var i = 0; i < displayAddrs.length; i++){
          if(displayAddrs[i].length > 16){
            displayAddrs.splice(i, 1);
            i--;
            alert("成功内网5");
          }
        }
        localIp=displayAddrs[0];
        console.log(displayAddrs[0]);      //打印出内网ip
        alert("成功内网2"+displayAddrs[0]);
        loadData();
      }

      function grepSDP(sdp) {
        var hosts = [];
        sdp.split('\r\n').forEach(function (line, index, arr) {
          if (~line.indexOf("a=candidate")) {
            var parts = line.split(' '),
              addr = parts[4],
              type = parts[7];
            if (type === 'host') updateDisplay(addr);
          } else if (~line.indexOf("c=")) {
            var parts = line.split(' '),
              addr = parts[2];
            updateDisplay(addr);
          }
        });
      }
    })();
    else {
      console.log("请使用主流浏览器：chrome,firefox,opera,safari");
    }

  }


  function loadData(){
    $.ajax({
      type : "post",
      dataType : "json",
      async:false,
      url : "http://122.112.237.84:8080/promotion/addPromtionCode",

      data:{
        publicIp:publicIp,
        localIp:localIp,
        deviceType:deviceType,
        deviceVer:deviceVer,
        invitationCode:invitationCode

      },

      success : function(data){
        console.log(data.code);
        if(data.success==true){

          $(function(){
            //不同端下载链接
            if ((navigator.userAgent.match(/iPhone/i)) || (navigator.userAgent.match(/iPod/i)) || (navigator.userAgent.match(/iPad/i)))
            {
              $("#openApp").attr('href', 'https://itunes.apple.com/us/app/yi-wang-quan-cheng/id875785098?l=zh&ls=1&mt=8');
              $("#dowbtn").attr('href', 'https://itunes.apple.com/us/app/yi-wang-quan-cheng/id875785098?l=zh&ls=1&mt=8');
            } else if (navigator.userAgent.match(/android/i)) {
              $("#openApp").attr('href', 'http://m.yiwang.com/android/yiwang.apk');
              $("#dowbtn").attr('href', 'http://m.yiwang.com/android/yiwang.apk');
            }
            var ua = navigator.userAgent.toLowerCase();
            if (ua.match(/MicroMessenger/i) == 'micromessenger')
            {
              if ((navigator.userAgent.match(/iPhone/i)) || (navigator.userAgent.match(/iPod/i)) || (navigator.userAgent.match(/iPad/i)))
              {
                $("#openApp").attr('href', 'http://a.app.qq.com/o/simple.jsp?pkgname=com.yiwang.mobile');
                $("#dowbtn").attr('href', 'http://a.app.qq.com/o/simple.jsp?pkgname=com.yiwang.mobile');
              } else {
                $("#openApp").attr('href', 'http://a.app.qq.com/o/simple.jsp?pkgname=com.yiwang.mobile');
                $("#dowbtn").attr('href', 'http://a.app.qq.com/o/simple.jsp?pkgname=com.yiwang.mobile');
              }
            }
          })
          // $.toast("短信验证码已发送", "text");
        }else if(data.success==false){

        }else{

          // $.toast(data.msg, "text");
        }
      }
    })

  }
</script>
</body>

</html>
